<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Gouvernement – Demo Supabase</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,Arial,sans-serif;padding:24px}
      li{margin:6px 0}
      .err{color:#b00020;white-space:pre-wrap;margin-top:16px}
      code{background:#f4f4f4;padding:2px 4px;border-radius:4px}
    </style>
  </head>
  <body>
    <h1>Personnes</h1>
    <ul id="list">Chargement…</ul>
    <div id="error" class="err"></div>

    <!-- Auth UI -->
    <div id="authBox" style="display:grid;gap:8px;margin-bottom:12px">
      <div id="auth-logged-out">
        <input id="auth-email" type="email" placeholder="email@domaine.com" />
        <button id="auth-login">Se connecter (lien magique)</button>
      </div>
      <div id="auth-logged-in" style="display:none">
        Connecté : <span id="auth-who"></span>
        <button id="auth-logout">Se déconnecter</button>
      </div>
      <div id="auth-msg" style="font-size:12px;color:#666"></div>
    </div>

    <!-- Formulaire d’ajout/modification de personne -->
    <div id="person-form-container" style="margin-top:32px;padding:16px;border:1px solid #eee;max-width:340px;">
      <h2 style="margin-top:0;font-size:1.1em;">Ajouter ou modifier une personne</h2>
      <form id="person-form">
        <div style="margin-bottom:12px;">
          <label for="full_name" style="display:block;margin-bottom:4px;">Nom complet</label>
          <input type="text" id="full_name" name="full_name" style="width:100%;padding:6px;" required>
        </div>
        <div style="margin-bottom:12px;">
          <label for="photo_url" style="display:block;margin-bottom:4px;">URL de la photo</label>
          <input type="text" id="photo_url" name="photo_url" style="width:100%;padding:6px;" required>
        </div>
        <button type="submit" style="padding:8px 16px;">Enregistrer</button>
      </form>
      <div id="form-error" class="err"></div>
    </div>

    <script>
  // Variables globales Supabase
  window.SUPABASE_URL = "https://sflfclyfwxvbuvrabnwf.supabase.co";
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmbGZjbHlmd3h2YnV2cmFibndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTc1MDEsImV4cCI6MjA3NTIzMzUwMX0.iuOs3nxotZ5_cE3XZ-j41DW04Wksf9zMWYvyOxAHOE4";

      async function loadPersons() {
        const ul = document.getElementById("list");
        const errBox = document.getElementById("error");
        errBox.textContent = "";

        try {
    const url = `${window.SUPABASE_URL}/rest/v1/persons?select=*`;
          const res = await fetch(url, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          });

          if (!res.ok) {
            const text = await res.text();
            errBox.textContent = `Erreur ${res.status} ${res.statusText}\n${text}`;
            ul.textContent = "—";
            return;
          }

          const data = await res.json();
          ul.innerHTML = "";
          data.forEach(p => {
            const li = document.createElement("li");
            li.textContent = p.full_name;
            ul.appendChild(li);
          });
          if (data.length === 0) ul.textContent = "Aucune personne";
        } catch (e) {
          document.getElementById("error").textContent = String(e);
          ul.textContent = "—";
        }
      }

      loadPersons();
      // Gestion du formulaire d’ajout/modification
      document.getElementById("person-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const fullName = document.getElementById("full_name").value.trim();
        const photoUrl = document.getElementById("photo_url").value.trim();
        const formError = document.getElementById("form-error");
        formError.textContent = "";

        if (!fullName || !photoUrl) {
          formError.textContent = "Veuillez remplir tous les champs.";
          return;
        }

        try {
    const url = `${window.SUPABASE_URL}/rest/v1/persons`;
          const body = JSON.stringify({ full_name: fullName, photo_url: photoUrl });
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              Prefer: "return=representation"
            },
            body
          });
          if (!res.ok) {
            const text = await res.text();
            formError.textContent = `Erreur ${res.status} ${res.statusText}\n${text}`;
            return;
          }
          // Réinitialise le formulaire et recharge la liste
          document.getElementById("person-form").reset();
          loadPersons();
        } catch (err) {
          formError.textContent = String(err);
        }
      });
    </script>
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      const el = (id)=>document.getElementById(id);
      const needsEditor = [
        "btnEditToggle","btnAdd","btnLink","btnFinish",
        "btnRename","btnDuplicate","btnDelete","btnSave"
      ];

      function setEditorEnabled(on){
        needsEditor.forEach(id=>{
          const b = el(id); if(!b) return;
          b.disabled = !on; b.classList.toggle("muted", !on);
        });
      }

      async function refreshAuth(){
        const { data: { user } } = await supabase.auth.getUser();
        const isLogged = !!user;

        el("auth-logged-in").style.display  = isLogged ? "" : "none";
        el("auth-logged-out").style.display = isLogged ? "none" : "";
        el("auth-who").textContent = user?.email || "";

        // Récupère le rôle applicatif
        let isEditor = false;
        if (user) {
          const { data: rows } = await supabase
            .from("user_roles")
            .select("role")
            .eq("user_id", user.id)
            .maybeSingle();
          isEditor = rows ? ["editor","admin"].includes(rows.role) : false;
        }
        setEditorEnabled(isEditor);
      }

      // Login (magic link)
      el("auth-login")?.addEventListener("click", async () => {
        const email = el("auth-email").value.trim();
        if (!email) return el("auth-msg").textContent = "Entre un email.";
        const { error } = await supabase.auth.signInWithOtp({ email });
        el("auth-msg").textContent = error ? ("Erreur : " + error.message)
                                           : "Email envoyé ✅ Vérifie ta boîte mail.";
      });

      // Logout
      el("auth-logout")?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        await refreshAuth();
      });

      // Suivre les changements de session
      supabase.auth.onAuthStateChange(async () => { refreshAuth(); });

      // Démarrage
      refreshAuth();
    </script>
  </body>
</html>
